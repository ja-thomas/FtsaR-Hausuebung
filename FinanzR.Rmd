---
title: "author_FinanzR"
author: "author"
date: "10. März 2015"
output: html_document
---

```{r encoding, echo=FALSE}
options(Encoding="UTF-8")
```

# Aufgabe 1

Download stocks

```{r stocks, echo=TRUE}
library(tseries)
library(timeDate)
library(MASS)
library(car)
library(zoo)
library(forecast)
library(fGarch)
library(parallel)

# Load stocks
vow <- get.hist.quote(start="2006-01-01", instrument="vow.de", quote="AdjClose")
dai <- get.hist.quote(start="2006-01-01", instrument="dai.de", quote="AdjClose")

# Create returns
rvow <-diff(log(vow))
rdai <- diff(log(dai))

# Create list
rstocks <- list(rvow = rvow, rdai = rdai)
```

* Eigenschaften der univariaten unbedingten Verteilungen
```{r univunbvert}
options(scipen = 10)

sapply(rstocks, function(x) c(mean=mean(x), 
                              var = var(x),
                              skew = skewness(x),
                              kurt = kurtosis(x)))

layout(matrix(c(1,3,2,3), 2, 2, byrow = TRUE))
truehist(rvow)
qqPlot(rvow)
boxplot(coredata(rvow))
mtext("Return Volkswagen", outer = TRUE, side = 3, line = -3)

truehist(rdai)
qqPlot(rdai)
boxplot(coredata(rdai))
mtext("Return Daimler", outer = TRUE, side = 3, line = -3)

layout(1)
```

* Zeitliche Abhängigkeitsstruktur der Renditen und von Transformationen der Renditen
```{r}


par(mfrow = c(3, 1))
ts.plot(rvow)
title("Time Series Volkswagen")
ts.plot(abs(rvow))
ts.plot(rvow^2)

ts.plot(rdai)
title("Time Series Daimler")
ts.plot(abs(rdai))
ts.plot(rdai^2)

acf(rvow, na.action=na.pass, main = "")
title("ACF Volkswagen")
acf(abs(rvow), na.action=na.pass, main = "absolut")
acf(rvow^2, na.action=na.pass, main = "squared")

acf(rdai, na.action=na.pass, main = "")
title("ACF Daimler")
acf(abs(rdai), na.action=na.pass, main = "absolut")
acf(rdai^2, na.action=na.pass, main = "squared")

par(mfrow = c(1, 1))
```

* Abhängigkeiten zwischen den Renditen der beiden Aktien
```{r, warning=FALSE}
cor(rvow, rdai)
scatterplot(rdai,rvow)
ccf(as.numeric(rvow), as.numeric(rdai),  na.action = na.fail)

# Copula
q.rdai <- rank(as.numeric(rdai))/(length(as.numeric(rdai)) + 1)
q.rvow <- rank(as.numeric(rvow))/(length(as.numeric(rvow)) + 1)
plot(q.rdai, q.rvow)
```

* Wie können Sie zeitliche Schwankungen Abhängigkeitsstruktur diagnostizieren?
```{r, }
acf(rvow)
Box.test(rvow, lag=5, type="Ljung-Box")

acf(rdai)
Box.test(rdai, lag=5, type="Ljung-Box")
```

# Aufgabe 2

´auto.arima´

```{r autoarima}
(rvow_arima <- auto.arima(rvow, seasonal=FALSE, ic="bic"))
(rdai_arima <- auto.arima(rdai, seasonal = FALSE, ic = "bic"))


rvow_arima_res <- residuals(rvow_arima)
rdai_arima_res <- residuals(rdai_arima)

missings <- which(is.na(rvow_arima_res) | is.na(rdai_arima_res))

rvow_arima_res <- rvow_arima_res[-missings]
rdai_arima_res <- rdai_arima_res[-missings]

ts.plot(rvow_arima_res)
ts.plot(rdai_arima_res)


get_best_garch <- function(data){
  cond.dist <- c("norm", "snorm", "ged", "sged", "std", "sstd", "snig", "QMLE")
  delta <- c(1,2,3,4)
  
  param_set <- expand.grid(cond.dist, delta)

  garch_models <- mapply(FUN = garchFit, cond.dist = param_set$Var1, delta = param_set$Var2,
           MoreArgs = list(data = data,  include.skew = TRUE, include.shape = TRUE, trace=FALSE))
    garch_models <- list(
#   garch_norm = garchFit(data = data, cond.dist = "norm", 
#                          include.delta = TRUE, trace = FALSE),
#   garch_snorm = garchFit(data = data, cond.dist = "snorm", 
#                           include.delta = TRUE, include.skew = TRUE, 
#                           trace = FALSE),
#   garch_std = garchFit(data = data, cond.dist = "std", 
#                        include.delta = TRUE, include.shape = TRUE, 
#                        trace = FALSE),
#   garch_sstd = garchFit(data = data, cond.dist = "sstd", 
#                          include.delta = TRUE, include.skew = TRUE, 
#                          include.shape = TRUE, trace = FALSE),
#   garch_snig = garchFit(data = data, cond.dist = "snig", trace = FALSE),
#   garch_qmle = garchFit(data = data, cond.dist = "QMLE", trace = FALSE)
#   )
#   
  garch_models[[which.min(lapply(garch_models, function(x) x@fit$ics[2]))]]
}


rvow_garch <- get_best_garch(rvow_arima_res)
rdai_garch <- get_best_garch(rdai_arima_res)




```

* Residuen extrahieren
* GARCH(1,1) anpassen
* Innovationsverteilungen
*

